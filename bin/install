#!/bin/sh

################################################################################
#
# Server name
#

: ${server_name:=$1}
echo "${server_name}" | grep -E '^[a-z0-9.-]+$' >/dev/null
if [ $? -gt 0 ]; then
    echo "Invalid \$server_name: ${server_name:-(empty)}"
    exit 2
fi

################################################################################
#
# Installation defaults
#

: ${project_dir:=$(cd "$(dirname "$0")/.."; pwd)}

if   command -v brew            > /dev/null; then osname=darwin
elif command -v freebsd-version > /dev/null; then osname=freebsd
elif command -v apt-get         > /dev/null; then osname=linux
else
    echo 'Unable to determine the operating system'
    exit 1
fi
. ${project_dir}/bin/prepare.${osname}


################################################################################
#
# Installation
#

render() {
    sed \
        -e "s|__NAME__|${server_name}|" \
        -e "s|__NAMES__|${other_names}|" \
        -e "s|__PDIR__|${project_dir}|" \
        -e "s|__USER__|${user}|" \
        -e "s|__GROUP__|${group}|" \
        < $1 > $2
}


_stop_nginx
certbot certonly --standalone -d "${server_name}" "${other_names}"
render "${project_dir}/etc/nginx.conf" "${nginx_conf}"
render "${project_dir}/etc/uwsgi.ini" "${uwsgi_conf}"
_startup
